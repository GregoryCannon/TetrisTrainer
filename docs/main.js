!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="docs",n(n.s=4)}([function(e,t,n){"use strict";n.r(t),n.d(t,"NUM_ROW",(function(){return i})),n.d(t,"NUM_COLUMN",(function(){return r})),n.d(t,"PIXEL_SIZE",(function(){return o})),n.d(t,"SQUARE_SIZE",(function(){return a})),n.d(t,"LINE_CLEAR_DELAY",(function(){return s})),n.d(t,"BOARD_HEIGHT",(function(){return c})),n.d(t,"BOARD_WIDTH",(function(){return d})),n.d(t,"DISPLAY_FULL_WIDTH",(function(){return l})),n.d(t,"BOARD_TOP_MARGIN",(function(){return u})),n.d(t,"NEXT_BOX_WIDTH",(function(){return h})),n.d(t,"VACANT",(function(){return f})),n.d(t,"RED_COLOR",(function(){return S})),n.d(t,"BLUE_COLOR",(function(){return p})),n.d(t,"WHITE_COLOR",(function(){return E})),n.d(t,"SquareState",(function(){return g})),n.d(t,"COLOR_1",(function(){return m})),n.d(t,"COLOR_2",(function(){return y})),n.d(t,"COLOR_3",(function(){return I})),n.d(t,"COLOR_PALETTE",(function(){return A})),n.d(t,"Direction",(function(){return T})),n.d(t,"REWARDS",(function(){return R})),n.d(t,"CalculatePushdownPoints",(function(){return _})),n.d(t,"GetGravity",(function(){return L})),n.d(t,"GameState",(function(){return v})),n.d(t,"DASSpeed",(function(){return b})),n.d(t,"DASBehavior",(function(){return M})),n.d(t,"StartingBoardType",(function(){return O}));const i=20,r=10,o=3,a=8*o,s=18,c=a*i,d=a*r,l=a*(r+6),u=2*a,h=5*a,f="black",S="red",p="#2105f2",E="white",g={EMPTY:0,COLOR1:1,COLOR2:2,COLOR3:3},m={0:"rgb(0,88,248)",1:"rgb(0,168,0)",2:"rgb(216,0,204)",3:"rgb(0,88,248)",4:"rgb(228,0,88",5:"rgb(88,248,152)",6:"rgb(248,56,0)",7:"rgb(104,68,252)",8:"rgb(0,88,248)",9:"rgb(248,56,0)"},y={0:"rgb(60,188,252)",1:"rgb(148,248,24)",2:"rgb(248,120,248)",3:"rgb(88,216,84)",4:"rgb(88,248,152)",5:"rgb(104,136,252)",6:"rgb(124,124,124)",7:"rgb(168,0,32)",8:"rgb(248,56,0)",9:"rgb(252,160,68)"},I=Object.assign(m),A={1:m,2:y,3:I},T=Object.freeze({LEFT:1,RIGHT:2,DOWN:3,UP:4}),R={1:40,2:100,3:300,4:1200},D={0:48,1:43,2:38,3:33,4:28,5:23,6:18,7:13,8:8,9:6,10:5,11:5,12:5,13:4,14:4,15:4,16:3,17:3,18:3,19:2,29:1};function _(e){return e>=16?e-6:e}function L(e){return e<=18?D[e]:e<29?2:1}const v={FIRST_PIECE:"first_piece",RUNNING:"running",PAUSED:"paused",GAME_OVER:"game_over",START_SCREEN:"start_screen",ARE:"are",LINE_CLEAR:"line_clear",EDIT_STARTING_BOARD:"edit_starting_board",RANDOM_BOARD:"random_board"},b=Object.freeze({STANDARD:"standard",SLOW_MEDIUM:"slow_medium",MEDIUM:"medium",FAST:"fast",FASTDAS:"Fast DAS"}),M=Object.freeze({STANDARD:"standard",ALWAYS_CHARGED:"always_charged",CHARGE_ON_PIECE_SPAWN:"charge_on_piece_spawn"}),O=Object.freeze({EMPTY:"empty",DIG_PRACTICE:"dig practice",CUSTOM:"custom"})},function(e,t,n){"use strict";n.d(t,"i",(function(){return a})),n.d(t,"e",(function(){return s})),n.d(t,"h",(function(){return c})),n.d(t,"a",(function(){return d})),n.d(t,"d",(function(){return l})),n.d(t,"g",(function(){return u})),n.d(t,"f",(function(){return h})),n.d(t,"b",(function(){return f})),n.d(t,"c",(function(){return S}));const{DASSpeed:i,StartingBoardType:r,DASBehavior:o}=n(0),a=Object.freeze({REQUIRED:"required",DEFAULT:"default",NONE:"none"}),s=Object.freeze({DASSpeed:i.STANDARD,DASBehavior:o.STANDARD,DroughtModeEnabled:!1,DiggingHintsEnabled:!1,GameSpeedMultiplier:1,ParityHintsEnabled:!1,PieceSequence:"",Transition10Lines:!1,StartingBoardType:r.EMPTY,StartingLevel:18}),c={},d=(a.DEFAULT,i.MEDIUM,a.DEFAULT,o.CHARGE_ON_PIECE_SPAWN,{DiggingHintsEnabled:{type:a.DEFAULT,value:!0},StartingBoardType:{type:a.REQUIRED,value:r.DIG_PRACTICE}}),l={StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:i.MEDIUM},DASBehavior:{type:a.DEFAULT,value:o.CHARGE_ON_PIECE_SPAWN}},u={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:i.MEDIUM},DASBehavior:{type:a.DEFAULT,value:o.CHARGE_ON_PIECE_SPAWN}},h={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:19},Transition10Lines:{type:a.REQUIRED,value:!0},DASBehavior:{type:a.DEFAULT,value:o.CHARGE_ON_PIECE_SPAWN}},f={DroughtModeEnabled:{type:a.REQUIRED,value:!0}},S={StartingBoardType:{type:a.REQUIRED,value:r.CUSTOM}};a.DEFAULT},function(e,t,n){"use strict";n.r(t),n.d(t,"shouldTransitionEvery10Lines",(function(){return o})),n.d(t,"shouldTransitionEveryLine",(function(){return a})),n.d(t,"getStartingLevel",(function(){return s})),n.d(t,"shouldShowDiggingHints",(function(){return c})),n.d(t,"shouldShowParityHints",(function(){return d})),n.d(t,"getGameSpeedMultiplier",(function(){return l})),n.d(t,"getFrameSkipCount",(function(){return u})),n.d(t,"shouldReduceLongBars",(function(){return h})),n.d(t,"getPieceSequence",(function(){return f})),n.d(t,"getStartingBoardType",(function(){return S})),n.d(t,"shouldSetDASChargeOnPieceStart",(function(){return p})),n.d(t,"isDASAlwaysCharged",(function(){return E})),n.d(t,"getDASChargeAfterTap",(function(){return g})),n.d(t,"getDASWallChargeAmount",(function(){return m})),n.d(t,"getDASChargedFloor",(function(){return y})),n.d(t,"GetDASUnchargedFloor",(function(){return I})),n.d(t,"getDASTriggerThreshold",(function(){return A}));var i=n(0);const r=n(3);function o(){return r.getTransition10Lines()}function a(){return!1}function s(){return r.getStartingLevel()}function c(){return r.getDiggingHintsEnabled()}function d(){return r.getParityHintsEnabled()}function l(){return r.getGameSpeedMultiplier()}function u(){return Math.round(1/r.getGameSpeedMultiplier())}function h(){return r.getDroughtModeEnabled()}function f(){return r.getPieceSequence()}function S(){return r.getStartingBoardType()}function p(){const e=r.getDASBehavior();return e==i.DASBehavior.ALWAYS_CHARGED||e==i.DASBehavior.CHARGE_ON_PIECE_SPAWN}function E(){return r.getDASBehavior()==i.DASBehavior.ALWAYS_CHARGED}function g(){return r.getDASBehavior()==i.DASBehavior.ALWAYS_CHARGED?10:0}function m(){switch(r.getDASSpeed()){case i.DASSpeed.SLOW_MEDIUM:return 12;case i.DASSpeed.FAST:return 10;default:return A()}}function y(){return 10}function I(){return 0}function A(){let e;const t=r.getDASSpeed();switch(t){case i.DASSpeed.STANDARD:e=6;break;case i.DASSpeed.FAST:case i.DASSpeed.FASTDAS:e=4;break;case i.DASSpeed.SLOW_MEDIUM:case i.DASSpeed.MEDIUM:e=5;break;default:throw new Error("Unknown DAS speed: "+t)}return 10+e}},function(e,t,n){"use strict";n.r(t),n.d(t,"getStartingLevel",(function(){return b})),n.d(t,"getTransition10Lines",(function(){return M})),n.d(t,"getDroughtModeEnabled",(function(){return O})),n.d(t,"getDiggingHintsEnabled",(function(){return C})),n.d(t,"getParityHintsEnabled",(function(){return P})),n.d(t,"getGameSpeedMultiplier",(function(){return N})),n.d(t,"getDASSpeed",(function(){return w})),n.d(t,"getDASBehavior",(function(){return U})),n.d(t,"getPieceSequence",(function(){return B})),n.d(t,"getStartingBoardType",(function(){return k})),n.d(t,"loadPreset",(function(){return G}));var i=n(0);const r=()=>document.fullscreenEnabled||document.webkitFullscreenEnabled,o=()=>null!=document.fullscreenElement||null!=document.webkitFullscreenElement,a=e=>{e.requestFullscreen?e.requestFullscreen({navigationUI:"hide"}):e.webkitRequestFullScreen&&e.webkitRequestFullScreen()},s=()=>{document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()},c=e=>{document.addEventListener("fullscreenchange",(function(){e()}),!1),document.addEventListener("webkitfullscreenchange",(function(){e()}),!1)};var d=n(1);const l=document.getElementById("das-speed-dropdown"),u=document.getElementById("das-behavior-dropdown"),h=document.getElementById("game-speed-dropdown"),f=document.getElementById("starting-board"),S=document.getElementById("drought-checkbox"),p=document.getElementById("digging-hints-checkbox"),E=document.getElementById("parity-hints-checkbox"),g=document.getElementById("transition-10-checkbox"),m=document.getElementById("piece-sequence"),y=document.getElementById("level-select"),I=document.getElementById("fullscreen-checkbox"),A=function(){if(document.cookie){console.log("cookie:",document.cookie);const e=document.cookie.split(";")[0],t=document.cookie.split("; ").find(e=>e.startsWith("userPrefs=")),n=t&&t.split("=")[1];return JSON.parse(unescape(n||e))}return JSON.parse(JSON.stringify(d.e))}(),T=[i.DASSpeed.STANDARD,i.DASSpeed.SLOW_MEDIUM,i.DASSpeed.MEDIUM,i.DASSpeed.FAST,i.DASSpeed.FASTDAS],R=[i.DASBehavior.STANDARD,i.DASBehavior.ALWAYS_CHARGED,i.DASBehavior.CHARGE_ON_PIECE_SPAWN],D=[i.StartingBoardType.EMPTY,i.StartingBoardType.DIG_PRACTICE,i.StartingBoardType.CUSTOM];function _(){document.cookie="userPrefs="+escape(JSON.stringify(A))+"; expires=Thu, 18 Dec 2030 12:00:00 UTC",console.log("cookie:",document.cookie)}function L(){for(const e of document.getElementById("level-choice-buttons").children)e.id.split("-")[1]===y.value?e.classList.add("selected"):e.classList.remove("selected")}function v(e,t){switch(e){case"DASSpeed":l.value=T.findIndex(e=>e==t);break;case"DASBehavior":u.value=R.findIndex(e=>e==t);break;case"DroughtModeEnabled":S.checked=t;break;case"DiggingHintsEnabled":p.checked=t;break;case"GameSpeedMultiplier":h.value=t;break;case"ParityHintsEnabled":E.checked=t;break;case"PieceSequence":m.value=t;break;case"Transition10Lines":g.checked=t;break;case"StartingBoardType":f.value=D.findIndex(e=>e==t);break;case"StartingLevel":y.value=t,L()}}function b(){const e=parseInt(y.value);return Math.max(e,0)}function M(){return g.checked}function O(){return S.checked}function C(){return p.checked}function P(){return E.checked}function N(){return h.value}function w(){const e=parseInt(l.value);return T[e]}function U(){const e=parseInt(u.value);return R[e]}function B(){const e=m.value.toUpperCase();let t="";for(const n of e)["I","O","L","J","T","S","Z"].includes(n)&&(t+=n);return t}function k(){return D[f.value]}function G(e){const t=[["DASSpeed",l],["DASBehavior",u],["DroughtModeEnabled",S],["DiggingHintsEnabled",p],["GameSpeedMultiplier",h],["ParityHintsEnabled",E],["PieceSequence",m],["Transition10Lines",g],["StartingBoardType",f],["StartingLevel",y]];for(const n of t){const t=n[0],i=n[1],r="StartingLevel"==t?i.parentElement:i.parentElement.parentElement,o=i.parentElement.parentElement;t in e?(v(t,e[t].value),r.classList.add("selected-row"),e[t].type==d.i.REQUIRED&&o.classList.add("disabled-row")):(v(t,A[t]),r.classList.remove("selected-row"),o.classList.remove("disabled-row"))}}l.addEventListener("change",e=>{A.DASSpeed=w(),_()}),u.addEventListener("change",e=>{A.DASBehavior=U(),_()}),p.addEventListener("change",e=>{A.DiggingHintsEnabled=C(),_()}),E.addEventListener("change",e=>{A.ParityHintsEnabled=P(),_()}),r()&&(I.disabled=!1,I.onchange=()=>{if(o())s(),I.checked=!1;else{let e=document.querySelector("#game-container");e&&(console.log("enable sullsce"),a(e),I.checked=!0)}},c(()=>{I.checked=!!o()})),y.addEventListener("change",e=>{L()}),[0,5,8,9,15,18,19,29].forEach(e=>{document.getElementById("level-"+e).addEventListener("click",t=>{y.value=e,L(),A.StartingLevel=b(),_()})})},function(e,t,n){"use strict";n.r(t),n.d(t,"GetCurrentPiece",(function(){return Je})),n.d(t,"GetLevel",(function(){return $e})),n.d(t,"GetLines",(function(){return Ke})),n.d(t,"GetIsPaused",(function(){return ze})),n.d(t,"G_Restart",(function(){return et})),n.d(t,"G_Rewind",(function(){return tt})),n.d(t,"G_FastForward",(function(){return nt})),n.d(t,"G_StartPause",(function(){return it})),n.d(t,"G_Quit",(function(){return rt})),n.d(t,"calcParity",(function(){return ut})),n.d(t,"G_MovePieceLeft",(function(){return pt})),n.d(t,"G_MovePieceRight",(function(){return Et})),n.d(t,"G_MoveCurrentPieceDown",(function(){return gt})),n.d(t,"G_RotatePieceLeft",(function(){return It})),n.d(t,"G_RotatePieceRight",(function(){return At})),n.d(t,"G_GetGameState",(function(){return Rt}));const i={Z:[[[[0,0,0,0],[0,1,1,0],[0,0,1,1]],[[0,0,0,1],[0,0,1,1],[0,0,1,0]]],2,"Z"],S:[[[[0,0,0,0],[0,0,1,1],[0,1,1,0]],[[0,0,1,0],[0,0,1,1],[0,0,0,1]]],3,"S"],T:[[[[0,0,0,0],[0,1,1,1],[0,0,1,0]],[[0,0,1,0],[0,1,1,0],[0,0,1,0]],[[0,0,1,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,1],[0,0,1,0]]],1,"T"],O:[[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]],1,"O"],L:[[[[0,0,0,0],[0,1,1,1],[0,1,0,0]],[[0,1,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,1],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,1]]],2,"L"],I:[[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]],1,"I"],J:[[[[0,0,0,0],[0,1,1,1],[0,0,0,1]],[[0,0,1,0],[0,0,1,0],[0,1,1,0]],[[0,1,0,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,1],[0,0,1,0],[0,0,1,0]]],3,"J"]},r=Object.values(i),o=n(2);function a(){this.sequence=[],this.startOfRandomSequence=0,this.readIndex=0}function s(e){let t=Math.floor(Math.random()*(r.length+1));const n=t!==r.length?r[t][2]:"";(t==r.length||n===e||o.shouldReduceLongBars()&&"I"==n)&&(t=Math.floor(Math.random()*r.length));return r[t][2]}a.prototype.generatePieceSequence=function(){const e=o.getPieceSequence();let t=0;if(e.length>0)for(let n=0;n<e.length;n++)this.sequence[n]=e.charAt(n),t++;for(;t<2e3;){const e=0==t?null:this.sequence[t-1];this.sequence[t]=s(e),t++}this.readIndex=0,this.startOfRandomSequence=e.length},a.prototype.getReadIndex=function(){return this.readIndex},a.prototype.setReadIndex=function(e){this.readIndex=e},a.prototype.getNextPiece=function(){const e=this.sequence[this.readIndex];return this.readIndex++,i[e]},a.prototype.getStatusDisplay=function(){return this.readIndex<this.startOfRandomSequence?["Piece ",this.readIndex+"/"+this.startOfRandomSequence]:[]};var c=n(0);const d=document.getElementById("paste-area"),l=document.getElementById("pasted-image");let u=!1,h=[];function f(e,t){var n;this.board=e,this.canvas=t,n=this,d.onpaste=function(e){for(var t=(e.clipboardData||e.originalEvent.clipboardData).items,i=null,r=0;r<t.length;r++)0===t[r].type.indexOf("image")&&(i=t[r].getAsFile());if(null!==i){var o=new FileReader;o.onload=function(e){l.onload=function(){n.getBoardStateFromImage(l)},l.src=e.target.result},o.readAsDataURL(i)}}}f.prototype.resetBoard=function(){for(let e=0;e<c.NUM_ROW;e++)for(let t=0;t<c.NUM_COLUMN;t++)this.board[e][t]=u?h[e][t]:c.SquareState.EMPTY},f.prototype.didLoadBoardStateFromImage=function(){return u},f.prototype.getBoardStateFromImage=function(e){var t=document.getElementById("dummy-canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0),this.resetBoard();const i=(e.height/20+e.width/10)/2-.1;for(let e=0;e<c.NUM_COLUMN;e++)for(let t=0;t<c.NUM_ROW;t++){const r=Math.round((e+.5)*i),o=Math.round((t+.5)*i),a=n.getImageData(r,o,1,1).data;Math.max(a[0],a[1],a[2])>30?(n.fillStyle="RED",this.board[t][e]=c.SquareState.COLOR2):(n.fillStyle="GREEN",this.board[t][e]=c.SquareState.EMPTY),n.fillRect(r,o,3,3)}!function(e,t,n){let i=!1;for(let r=c.NUM_ROW-1;r>=0;r--)if(i)for(let t=0;t<c.NUM_COLUMN;t++)e[r][t]=c.SquareState.EMPTY;else{let o=!0;for(let t=0;t<c.NUM_COLUMN;t++)if(e[r][t]!=c.SquareState.EMPTY){o=!1;break}o&&(i=!0,t.fillStyle="BLACK",t.fillRect(0,0,n*c.NUM_COLUMN,r*n))}}(this.board,n,i),h=JSON.parse(JSON.stringify(this.board)),this.canvas.drawBoard(),u=!0,setTimeout(()=>{t.style.display="none"},3e3)};const S=document.getElementById("main-canvas"),p=S.getContext("2d"),E=n(2);function g(e){this.board=e}function m(e,t,n){return t<0||t>=c.NUM_COLUMN||e<0||e>=c.NUM_ROW||n[e][t]!=c.SquareState.EMPTY}function y(e,t,n){p.fillStyle=n,p.fillRect(t*c.SQUARE_SIZE+c.PIXEL_SIZE,e*c.SQUARE_SIZE+c.PIXEL_SIZE,c.SQUARE_SIZE-3*c.PIXEL_SIZE,c.SQUARE_SIZE-3*c.PIXEL_SIZE)}function I(e,t,n){for(let i=0;i<c.NUM_COLUMN;i++)n[e][i]==c.SquareState.EMPTY&&y(e,i,t)}function A(e){if((e=Math.floor(e))<0)throw new Error("Can't convert negative num to hex");return e<10?""+e:e<16?["a","b","c","d","e","f"][e-10]:"f"}function T(e,t){this.rotationList=e[0],this.colorId=e[1],this.id=e[2],this.board=t,this.rotationIndex=0,this.activeTetromino=this.rotationList[this.rotationIndex],this.x=3,this.y="I"==this.id?-2:-1}S.setAttribute("height",c.SQUARE_SIZE*c.NUM_ROW),S.setAttribute("width",c.SQUARE_SIZE*(c.NUM_COLUMN+7)),g.prototype.drawLineClears=function(e,t){if(t>=15)return;const n=5+Math.floor(t/3),i=9-n;for(const t of e)p.fillStyle="black",p.fillRect(i*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE),p.fillRect(n*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE)},g.prototype.drawSquare=function(e,t,n,i=!1){if(n==c.VACANT)return p.fillStyle="black",void p.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE);p.fillStyle=n,p.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,7*c.PIXEL_SIZE,7*c.PIXEL_SIZE),i&&n!==c.VACANT&&(p.fillStyle="white",p.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,5*c.PIXEL_SIZE,5*c.PIXEL_SIZE)),n!==c.VACANT&&(p.fillStyle="white",p.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),p.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),p.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),p.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE))},g.prototype.drawNextBox=function(e){const t=c.NUM_COLUMN+1;if(p.fillStyle="BLACK",p.fillRect(t*c.SQUARE_SIZE,8*c.SQUARE_SIZE,5*c.SQUARE_SIZE,4.5*c.SQUARE_SIZE),null!=e){const n="I"===e.id||"O"===e.id?t+.5:t,i="I"===e.id?7.75:8.25,r=c.COLOR_PALETTE[e.colorId][$e()%10];for(let t=0;t<e.activeTetromino.length;t++)for(let o=0;o<e.activeTetromino[t].length;o++)e.activeTetromino[t][o]&&this.drawSquare(n+o,i+t,r,1===e.colorId)}},g.prototype.drawScoreDisplay=function(e,t){const n=c.NEXT_BOX_WIDTH,i=c.BOARD_WIDTH+c.SQUARE_SIZE,r=.5*c.SQUARE_SIZE,o=e>=1e6?7:6,a=("0".repeat(o)+e).slice(-1*o);this.drawMultiLineText(["SCORE",a],i,r,n,"center",t)},g.prototype.drawLinesDisplay=function(e,t){const n=c.NEXT_BOX_WIDTH,i=c.BOARD_WIDTH+c.SQUARE_SIZE,r=3*c.SQUARE_SIZE,o=("0".repeat(3)+e).slice(-3);this.drawMultiLineText(["LINES",o],i,r,n,"center",t)},g.prototype.drawLevelDisplay=function(e,t){const n=c.NEXT_BOX_WIDTH,i=c.BOARD_WIDTH+c.SQUARE_SIZE,r=14*c.SQUARE_SIZE,o=("0".repeat(2)+e).slice(-2);this.drawMultiLineText(["LEVEL",o],i,r,n,"center",t)},g.prototype.drawTetrisRateDisplay=function(e,t,n){const i=c.NEXT_BOX_WIDTH,r=c.BOARD_WIDTH+c.SQUARE_SIZE,o=17*c.SQUARE_SIZE;let a=0;t>0&&(a=4*e/t);const s=parseInt(100*a);this.drawMultiLineText(["TRT",s+"%"],r,o,i,"center",n)},g.prototype.drawPieceStatusDisplay=function(e){const t=c.NEXT_BOX_WIDTH,n=c.BOARD_WIDTH+c.SQUARE_SIZE,i=6*c.SQUARE_SIZE;this.drawMultiLineText(e,n,i,t,"center")},g.prototype.drawMultiLineText=function(e,t,n,i,r,o){p.clearRect(t,n,i,20*e.length),p.textAlign="center",p.font="18px 'Press Start 2P'",p.fillStyle="string"==typeof o?o:"BLACK";const a="center"==r?i/2:0;let s=0;for(let i of e)p.fillText(i.toUpperCase(),t+a,n+20*(s+1)),s++},g.prototype.drawPiece=function(e){if(null==e)return;const t=$e(),n="T"===e.id||"O"===e.id||"I"===e.id;for(let i=0;i<e.activeTetromino.length;i++)for(let r=0;r<e.activeTetromino[i].length;r++)e.activeTetromino[i][r]&&(0!==e.colorId?this.drawSquare(e.x+r,e.y+i,c.COLOR_PALETTE[e.colorId][t%10],n):this.drawSquare(e.x+r,e.y+i,c.VACANT,n))},g.prototype.unDrawPiece=function(e){if(null!=e)for(let t=0;t<e.activeTetromino.length;t++)for(let n=0;n<e.activeTetromino[t].length;n++)e.activeTetromino[t][n]&&this.drawSquare(e.x+n,e.y+t,c.VACANT,!1)},g.prototype.drawCurrentPiece=function(){this.drawPiece(Je())},g.prototype.unDrawCurrentPiece=function(){this.unDrawPiece(Je())},g.prototype.drawBoard=function(){const e=$e();for(let t=0;t<c.NUM_ROW;t++)for(let n=0;n<c.NUM_COLUMN;n++){let i=this.board[t][n];0!==i?this.drawSquare(n,t,c.COLOR_PALETTE[i][e%10],1===i):this.drawSquare(n,t,c.VACANT,1===i)}E.shouldShowDiggingHints()&&this.drawDiggingHints(),E.shouldShowParityHints()&&this.drawParityHints()},g.prototype.drawDiggingHints=function(){const e=function(e){for(let t=0;t<c.NUM_ROW;t++)for(let n=0;n<c.NUM_COLUMN;n++)if(e[t][n]==c.SquareState.EMPTY&&m(t-1,n,e)&&m(t+1,n,e)&&m(t,n-1,e)&&m(t,n+1,e))return[t,n];return[]}(this.board),t=function(e){let t=c.NUM_ROW-1,n=[];for(;!m(t,c.NUM_COLUMN-1,e);)t--;for(;t>=0&&m(t,c.NUM_COLUMN-1,e);)n.push(t),t--;return n}(this.board);if(e.length>0){const t=e[0],n=e[1];let i=[],r=t-1;for(;r>=0&&m(r,n,this.board);)i.push(r),r-=1;const o=(t+.45)*c.SQUARE_SIZE,a=(n+.45)*c.SQUARE_SIZE,s=c.SQUARE_SIZE/4;p.fillStyle="yellow",p.beginPath(),p.arc(a,o,s,0,2*Math.PI,!1),p.fill();for(let e of i)I(e,"#842424",this.board)}else if(t.length>0)for(let e of t)I(e,"#215E30",this.board)},g.prototype.drawParityHints=function(){const e=[];for(let t=0;t<c.NUM_COLUMN;t++)e[t]=ut(t-2,t+3);let t=[];for(let n=0;n<c.NUM_COLUMN;n++){let i=0,r=0;if([n-1,n,n+1].forEach(t=>{t>=0&&t<c.NUM_COLUMN&&(i+=e[t],r+=1)}),0==r)throw new Error("None added");t[n]=i/r}for(let e=0;e<c.NUM_COLUMN;e++){const n=t[e];for(let t=0;t<c.NUM_ROW;t++)if(this.board[t][e]==c.SquareState.EMPTY){const i=A(Math.max(5*n-4,0));y(t,e,"#ff0000"+i+i)}}},T.prototype.equals=function(e){return this.id===e.id},T.prototype.getHeightFromBottom=function(){let e=0;for(let t=0;t<this.activeTetromino.length;t++)for(let n=0;n<this.activeTetromino[t].length;n++)this.activeTetromino[t][n]&&(e=Math.max(e,this.y+t));return c.NUM_ROW-e},T.prototype.shouldLock=function(){return this.collision(0,1,this.activeTetromino)},T.prototype.moveDown=function(){this.y++},T.prototype.moveRight=function(){return!this.collision(1,0,this.activeTetromino)&&(this.x++,!0)},T.prototype.moveLeft=function(){return!this.collision(-1,0,this.activeTetromino)&&(this.x--,!0)},T.prototype.rotate=function(e){const t=e?1:-1,n=(this.rotationIndex+t+this.rotationList.length)%this.rotationList.length,i=this.rotationList[n];this.collision(0,0,i)||(this.rotationIndex=n,this.activeTetromino=this.rotationList[this.rotationIndex])},T.prototype.lock=function(){for(let e=0;e<this.activeTetromino.length;e++)for(let t=0;t<this.activeTetromino[e].length;t++){if(!this.activeTetromino[e][t])continue;const n=this.y+e,i=this.x+t;n>=0&&n<c.NUM_ROW&&i>=0&&i<c.NUM_COLUMN&&(this.board[this.y+e][this.x+t]=this.colorId)}},T.prototype.collision=function(e,t,n){for(let i=0;i<n.length;i++)for(let r=0;r<n[i].length;r++){if(!n[i][r])continue;let o=this.x+r+e,a=this.y+i+t;if(o<0||o>=c.NUM_COLUMN||a>=c.NUM_ROW)return!0;if(!(a<0)&&0!=this.board[a][o])return!0}return!1};const R=n(2),D=document.getElementById("edit-key");let _={RESTART:"r",REWIND:"v",FAST_FORWARD:"b",START_PAUSE:"Enter",QUIT:"q",ROTATE_LEFT:"z",ROTATE_RIGHT:"x",LEFT:"ArrowLeft",DOWN:"ArrowDown",RIGHT:"ArrowRight"};const L=[["key-rot-left","ROTATE_LEFT"],["key-rot-right","ROTATE_RIGHT"],["key-left","LEFT"],["key-right","RIGHT"],["key-down","DOWN"],["key-start-pause","START_PAUSE"],["key-restart","RESTART"],["key-undo","REWIND"],["key-redo","FAST_FORWARD"],["key-quit","QUIT"]];function v(){this.getKeyMapFromCookie(),this.resetLocalVariables(),this.addKeyClickListeners()}v.prototype.saveKeyMapToCookie=function(){document.cookie="keymap="+escape(JSON.stringify(_))+"; expires=Thu, 18 Dec 2030 12:00:00 UTC",console.log("saved new cookie:",document.cookie)},v.prototype.getKeyMapFromCookie=function(){if(document.cookie){const e=document.cookie.split("; ").find(e=>e.startsWith("keymap="));if(e){const t=e.split("=")[1];_=JSON.parse(unescape(t)),this.refreshKeyVisuals()}}},v.prototype.addKeyClickListeners=function(){for(const[e,t]of L)document.getElementById(e).addEventListener("click",()=>{this.keyBeingEdited=t,D.style.visibility="visible"})};const b={ArrowLeft:"←",ArrowDown:"↓",ArrowRight:"→"};function M(e){return!ze()&&(e==c.GameState.RUNNING||e==c.GameState.FIRST_PIECE)}v.prototype.refreshKeyVisuals=function(){for(const[e,t]of L){const n=_[t];document.getElementById(e).innerHTML=b[n]||n.toUpperCase()}},v.prototype.getIsSoftDropping=function(){return this.isSoftDropping},v.prototype.getCellsSoftDropped=function(){return this.cellSoftDropped},v.prototype.onPieceLock=function(){R.shouldSetDASChargeOnPieceStart()?this.setDASCharge(R.getDASWallChargeAmount()):this.setDASCharge(Math.min(R.getDASWallChargeAmount(),this.dasCharge))},v.prototype.resetLocalVariables=function(){this.leftHeld=!1,this.rightHeld=!1,this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0,this.dasCharge=R.getDASTriggerThreshold(),this.softDroppedLastFrame=!1,this.keyBeingEdited=null},v.prototype.handleInputsThisFrame=function(){if(this.downHeld+this.leftHeld+this.rightHeld>1)return this.isSoftDropping=!1,void(this.cellSoftDropped=0);if(this.isSoftDropping&&!this.softDroppedLastFrame){return gt()?this.cellSoftDropped+=1:(this.isSoftDropping=!1,this.cellSoftDropped=0),void(this.softDroppedLastFrame=!0)}this.softDroppedLastFrame=!1,this.leftHeld?this.handleHeldDirection(c.Direction.LEFT):this.rightHeld&&this.handleHeldDirection(c.Direction.RIGHT)},v.prototype.keyDownListener=function(e){if(e.repeat)return void e.preventDefault();switch(this.keyBeingEdited&&(_[this.keyBeingEdited]=e.key,this.keyBeingEdited=null,D.style.visibility="hidden",this.refreshKeyVisuals(),this.saveKeyMapToCookie()),e.key){case _.RESTART:et();break;case _.REWIND:tt();break;case _.FAST_FORWARD:nt();break;case _.START_PAUSE:it();break;case _.QUIT:rt()}switch(e.key){case _.LEFT:this.leftHeld=!0,e.preventDefault();break;case _.RIGHT:this.rightHeld=!0,e.preventDefault();break;case _.DOWN:this.downHeld=!0,e.preventDefault()}const t=Rt();if(M(t))switch(e.key){case _.LEFT:this.handleTappedDirection(c.Direction.LEFT);break;case _.RIGHT:this.handleTappedDirection(c.Direction.RIGHT);break;case _.ROTATE_LEFT:It();break;case _.ROTATE_RIGHT:At()}else switch(e.key){case _.ROTATE_LEFT:case _.ROTATE_RIGHT:console.log("rotate rejected, state: ",Rt())}if(function(e){return!ze()&&e==c.GameState.RUNNING}(t))switch(e.key){case _.DOWN:this.isSoftDropping=!0}},v.prototype.keyUpListener=function(e){e.key==_.LEFT?this.leftHeld=!1:e.key==_.RIGHT?this.rightHeld=!1:e.key==_.DOWN&&(this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0)},v.prototype.tryShiftPiece=function(e){const t=e==c.Direction.LEFT?pt():Et();return t||this.setDASCharge(R.getDASTriggerThreshold()),t},v.prototype.handleHeldDirection=function(e){const t=R.getDASTriggerThreshold();if(this.setDASCharge(Math.min(t,this.dasCharge+1)),this.dasCharge==t){this.tryShiftPiece(e)&&this.setDASCharge(R.getDASChargedFloor())}},v.prototype.handleTappedDirection=function(e){M(Rt())&&(this.setDASCharge(R.getDASChargeAfterTap()),this.tryShiftPiece(e))},v.prototype.setDASCharge=function(e){this.dasCharge=e},v.prototype.refreshDebugText=function(){let e="",t="";for(let e=0;e<this.dasCharge;e++)t+="|";0==this.dasCharge&&(t="."),e+=this.dasCharge+"/"+R.getDASTriggerThreshold()+"\n"+t};const O=document.getElementById("main-canvas");function C(e,t){this.board=e,this.canvas=t,this.mouseIsDown=!1,this.squaresToggled=new Set,this.dragMode=P.NONE}const P=Object.freeze({ADDING:"adding",REMOVING:"removing",NONE:"none"});function N(e){const t=O.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;return[Math.floor(i/c.SQUARE_SIZE),Math.floor(n/c.SQUARE_SIZE)]}function w(e,t){return e+","+t}C.prototype.toggleCell=function(e,t){this.squaresToggled.add(w(e,t)),this.board[e][t]=this.board[e][t]==c.SquareState.EMPTY?c.SquareState.COLOR1:c.SquareState.EMPTY,this.canvas.drawBoard(),this.canvas.drawCurrentPiece()},C.prototype.onMouseDown=function(e){let t,n;[t,n]=N(e),this.mouseIsDown=!0,this.dragMode=this.board[t][n]==c.SquareState.EMPTY?P.ADDING:P.REMOVING,this.toggleCell(t,n)},C.prototype.onMouseDrag=function(e){if(!this.mouseIsDown)return;let t,n;[t,n]=N(e);(this.dragMode==P.ADDING?this.board[t][n]==c.SquareState.EMPTY:this.board[t][n]!=c.SquareState.EMPTY)&&!this.squaresToggled.has(w(t,n))&&this.toggleCell(t,n)},C.prototype.onMouseUp=function(e){this.mouseIsDown=!1,this.squaresToggled=new Set};const{NUM_COLUMN:U,NUM_ROW:B,SquareState:k}=n(0);function G(e,t){this.board=e}function x(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}G.prototype.loadEmptyBoard=function(){for(let e=0;e<B;e++)for(let t=0;t<U;t++)this.board[e][t]=k.EMPTY},G.prototype.loadStandardBoard=function(){this.loadEmptyBoard();let e=x(6,10);for(let t=0;t<U-1;t++){const n=Math.min(12,Math.max(0,e));for(let e=B-n-1;e<B;e++){const n=e%3,i=[k.COLOR1,k.COLOR2,k.COLOR3][n];this.board[e][t]=i}e+=x(-2,1)}};const H=.5,F=.4;function Z(){this.history=[],this.readIndex=-1}G.prototype.loadDigBoard=function(){this.loadStandardBoard();for(let e=0;e<B;e++){let t;const n=Math.random();t=n<H?0:n<H+F?1:2;for(let n=0;n<t;n++)this.board[e][x(0,U)]=k.EMPTY}},Z.prototype.addSnapshotToHistory=function(e){this.readIndex+=1,this.history[this.readIndex]=e},Z.prototype.rewindOnePiece=function(){this.readIndex-=1,this.readIndex=Math.max(0,this.readIndex)},Z.prototype.fastForwardOnePiece=function(){this.readIndex+=1,this.readIndex=Math.min(this.readIndex,this.history.length-1)},Z.prototype.loadSnapshotFromHistory=function(){return this.readIndex>=this.history.length?null:this.history[this.readIndex]},Z.prototype.resetHistory=function(){this.history=[],this.readIndex=-1};const q={a:"00000",b:"00001",c:"00010",d:"00011",e:"00100",f:"00101",g:"00110",h:"00111",i:"01000",j:"01001",k:"01010",l:"01011",m:"01100",n:"01101",o:"01110",p:"01111",q:"10000",r:"10001",s:"10010",t:"10011",u:"10100",v:"10101",w:"10110",x:"10111",y:"11000",z:"11001",A:"11010",B:"11011",C:"11100",D:"11101",E:"11110",F:"11111"};const W=document.getElementById("engine-grid"),Q=document.getElementById("inexhaustive-warning"),X=document.getElementById("inexhaustive-warning-text"),Y=document.getElementById("inexhaustive-warning-icon"),j=document.getElementById("engine-cur-piece"),V=document.getElementById("engine-next-piece"),J=document.getElementById("engine-tap-speed"),$=document.getElementById("engine-depth-select"),K=document.getElementById("engine-backend-error"),z=document.getElementById("engine-calculate-button");function ee(e){this.board=e,this.curPiece="O",this.nextPiece="",this.requestInfo={},this.pingServer(),z.addEventListener("click",e=>this.makeRequest())}function te(e){const t=function(e){if(e.includes(",")){const t=e.split(","),n=parseInt(t[0]),i=t[1],r=parseInt(t[2]),o=[];for(let e=0;e<n;e++)o.push([0,0,0,0,0,0,0,0,0,0]);for(let e=0;e<i.length;e+=2){const t=(q[i.charAt(e)]+q[i.charAt(e+1)]).split("");o.push(t.map(e=>parseInt(e)))}for(let e=0;e<r;e++)o.push([1,1,1,1,1,1,1,1,1,0]);if(20==o.length)return o;throw new Error("Invalid compressed board. Must contain 20 rows, but found: "+o.length)}}(e),n=document.createElement("canvas");n.width=50,n.height=100,n.style.background="#bbb";const i=n.getContext("2d");i.fillStyle="#444";for(let e=0;e<c.NUM_ROW;e++)for(let n=0;n<c.NUM_COLUMN;n++)1===t[e][n]&&i.fillRect(5*n+.5,5*e+.5,4.5,4.5);return n}function ne(e,t,n,i){const r=document.createElement("tr");r.style.backgroundColor=i;const o=document.createElement("td");o.classList.add("playout-table-left");const a=document.createElement("td");a.classList.add("playout-table-right"),r.appendChild(o),r.appendChild(a);const s=t.pieceSequence.split("");let c=[];for(let e=0;e<t.placements.length;e++){const n=t.placements[e];c.push(ce(s[e],n[0],n[1]))}const d=document.createElement("span");d.innerHTML=`<strong>${n}:</strong> ${t.score}<br/>&nbsp;&nbsp;${c.join("<br/>&nbsp;&nbsp;")}`,o.appendChild(d),a.appendChild(te(t.resultingBoard)),e.appendChild(r)}function ie(e,t,n){const i=document.createElement("div");i.style.display="flex",i.classList.add("immediate-info-panel"),i.appendChild(te(t.resultingBoard));const r=document.createElement("div");r.classList.add("immediate-info-right-panel"),i.appendChild(r);const o=document.createElement("div");o.innerHTML="Shallow Eval Score: "+t.shallowEvalScore,r.appendChild(o);const a=document.createElement("div");a.innerHTML="Eval Explanation: (not yet supported)",r.appendChild(a),e.appendChild(i);const s=document.createElement("table");s.classList.add("playout-table"),ne(s,t.playout1,"Best Seen Playout","#328532"),ne(s,t.playout2,"Good Case","#4c864c"),ne(s,t.playout3,"Above Avg Case","#6c8e6c"),ne(s,t.playout4,"Median Case","#767676"),ne(s,t.playout5,"Below Avg Case","#4e4e4e"),ne(s,t.playout6,"Bad Case","#373737"),ne(s,t.playout7,"Worst Seen Playout","#262626"),e.appendChild(s)}function re(e){"visible"===e.style.visibility?(e.style.maxHeight="0px",e.style.visibility="hidden",e.style.padding="0"):(e.style.visibility="visible",e.style.maxHeight="1500px",e.style.padding="10px 0")}ee.prototype.updatePieces=function(e,t){this.curPiece=e||"",this.nextPiece=t||"",j.value=this.curPiece,V.value=this.nextPiece},ee.prototype.pingServer=function(){fetch("https://stackrabbit.herokuapp.com/ping",{mode:"cors"}).then((function(e){return console.log("Received ack from server"),e.json()})).catch((function(e){console.log("Ping to server failed. Reason:",e)}))},ee.prototype.makeRequest=function(){const e=this.board.map(e=>e.slice(0,10).join("")).join("").replace(/2|3/g,"1"),t=j.value,n=V.value,i=J.value,r=$.value.split("x"),o=parseInt(r[0]),a=parseInt(r[1]),s=`https://stackrabbit.net/${n?"engine-movelist-cpp-hybrid":"engine-movelist-cpp"}?board=${e}&currentPiece=${t}${n?"&nextPiece="+n:""}&level=${Math.max($e()||0,18)}&lines=${Ke()||0}&inputFrameTimeline=${i}&playoutCount=${o}&playoutLength=${a}`;this.requestInfo={firstPiece:t,secondPiece:n,playoutCount:o,playoutLength:a,isExhaustive:o==Math.pow(7,a),isHybrid:!!n},fetch(s,{mode:"cors"}).then((function(e){return e.text()})).then(function(e){if(!1===function(e){try{var t=JSON.parse(e);if(t&&"object"==typeof t)return t}catch(e){}return!1}(e))return console.log("Request failed",error),K.style.visibility="visible",K.innerHTML="Error loading analysis.<br/>"+e,W.style.visibility="hidden",null;let t;if(this.requestInfo.isHybrid){const n=JSON.parse(e);t=n.noNextBox.concat(n.nextBox)}else t=JSON.parse(e);this.loadResponseCpp(this.requestInfo,t)}.bind(this)).catch((function(e){console.log("Request failed",e),K.style.visibility="visible",K.innerHTML="Error loading analysis.<br/>"+e,W.style.visibility="hidden"})),z.disabled=!0,setTimeout(()=>{z.disabled=!1},2e3),document.activeElement.blur()},ee.prototype.loadResponseCpp=function(e,t){W.innerHTML="",K.style.visibility="hidden",W.style.visibility="visible";let n=0;for(let e=0;e<t.length&&!t[e].secondPlacement;e++)n+=1;Q.style.display="flex",this.requestInfo.isExhaustive?(Y.src="static/checkmark_transparent.webp",X.innerHTML="All possible piece sequences were tested."):(Y.src="static/warning_icon_transparent.webp",X.innerHTML=`At high depth, it's infeasible to test every possible piece sequence. Therefore there may be some variance in the evaluation.<br/><em>Playouts Performed: ${this.requestInfo.playoutCount}</em>`);let i=1;for(let r=0;r<t.length;r++){const o=t[r];if(r===n){i=1;const e=document.createElement("h4");e.innerHTML="Adjustments",e.classList.add("adjustments-header"),W.appendChild(e)}let a=document.createElement("div");W.appendChild(a),a.classList.add("grid-row","main-move");let s=document.createElement("div");a.appendChild(s),s.classList.add("ranking"),s.innerHTML=i+")",s+=1;let c=document.createElement("div");a.appendChild(c),c.classList.add("eval-score");const d=this.requestInfo.isExhaustive?1:0;c.innerHTML=(this.requestInfo.isExhaustive?"":"~")+o.playoutScore.toFixed(d);let l=document.createElement("div");const[u,h,f]=o.firstPlacement;if(l.innerHTML=ce(e.firstPiece,u,h),a.appendChild(l),o.secondPlacement){l.classList.add("notated-adj");const t=document.createElement("div");t.classList.add("notated-next");const[n,i,r]=o.secondPlacement;t.innerHTML=ce(e.secondPiece,n,i),a.appendChild(t)}else l.classList.add("notated-move");let S=document.createElement("div");W.appendChild(S),S.style.visibility="hidden",S.style.maxHeight="0px",S.classList.add("detail-view-cpp"),ie(S,o,e),a.addEventListener("click",e=>{re(S)}),i+=1}};const oe={I:["",""],O:[""],L:["d","l","u","r"],J:["d","l","u","r"],T:["d","l","u","r"],S:["",""],Z:["",""]},ae={I:[4,1],O:[2],L:[3,2,3,2],J:[3,2,3,2],T:[3,2,3,2],S:[3,2],Z:[3,2]},se={I:[4,6],O:[5],L:[5,5,5,6],J:[5,5,5,6],T:[5,5,5,6],S:[5,6],Z:[5,6]};function ce(e,t,n){const i=(t+4)%ae[e].length,r=oe[e][i],o=se[e][i]+n;let a="";for(let t=0;t<ae[e][i];t++)a+=(o+t).toString().slice(-1);return`${e}${r}-${a}`}const de=document.getElementById("main-canvas"),le=document.getElementById("left-panel-toggle-button"),ue=document.getElementById("left-panel");document.getElementById("right-panel");let he=!0;ue.style.minHeight=c.BOARD_HEIGHT+60,de.setAttribute("height",c.BOARD_HEIGHT),de.setAttribute("width",c.DISPLAY_FULL_WIDTH),le.innerText="<",le.addEventListener("click",(function(e){he=!he,he?(ue.style.marginLeft=0,le.innerText="<"):(ue.style.marginLeft=-290,le.innerText=">")}));var fe=n(1);const Se=n(2),pe=n(3),Ee=document.getElementById("header-text"),ge=document.getElementById("pre-game-config"),me=document.getElementById("random-board-reset-button"),ye=document.getElementById("main-canvas"),Ie=document.getElementById("center-panel"),Ae=window.matchMedia("(prefers-color-scheme: dark)");let Te=Ae&&Ae.matches?"white":"black";Ae.addEventListener("change",(function(e){Te=e.matches?"white":"black",ft()}));const Re=[];for(let e=0;e<c.NUM_ROW;e++){Re[e]=[];for(let t=0;t<c.NUM_COLUMN;t++)Re[e][t]=c.SquareState.EMPTY}let De,_e,Le,ve,be,Me,Oe,Ce,Pe,Ne,we,Ue,Be,ke,Ge,xe,He,Fe,Ze,qe=new g(Re),We=new C(Re,qe),Qe=new G(Re),Xe=new a,Ye=(new f(Re,qe),new Z),je=new ee(Re),Ve=!1;const Je=()=>_e,$e=()=>ve||Se.getStartingLevel(),Ke=()=>be,ze=()=>Ve,et=function(){(Tt()||Oe==c.GameState.GAME_OVER)&&st()},tt=function(){Ye.rewindOnePiece(),yt()},nt=function(){Ye.fastForwardOnePiece(),yt()},it=function(){Oe==c.GameState.GAME_OVER?(Oe=c.GameState.START_SCREEN,lt(),St()):Oe==c.GameState.START_SCREEN||Oe==c.GameState.EDIT_STARTING_BOARD||Oe==c.GameState.RANDOM_BOARD?st():Tt()&&(Ve=!Ve,lt())},rt=function(){console.log("QUIT"),Oe=c.GameState.START_SCREEN,lt(),St()};function ot(){_e=Le,Le=new T(Xe.getNextPiece(),Re)}function at(){we=0,Ge=0,Ue=0,ke=[],Ne=0,xe=Se.getFrameSkipCount(),Be=0,De.resetLocalVariables(),He=0,Fe=0,Ze=0}function st(){switch(Se.getStartingBoardType()){case c.StartingBoardType.EMPTY:Qe.loadEmptyBoard();break;case c.StartingBoardType.DIG_PRACTICE:Qe.loadDigBoard();break;case c.StartingBoardType.CUSTOM:Oe==c.GameState.EDIT_STARTING_BOARD||Oe==c.GameState.RANDOM_BOARD||Qe.loadEmptyBoard()}var e;ve=Se.getStartingLevel(),Me=Se.shouldTransitionEvery10Lines()?10:(e=ve)<10?10*(e+1):e<=15?100:e>=29?200:10*(e-5),Xe.generatePieceSequence(),(Oe!=c.GameState.EDIT_STARTING_BOARD&&Oe!=c.GameState.RANDOM_BOARD||null==_e||null==Le)&&(Le=new T(Xe.getNextPiece(),Re),ot(),ht(Le)),qe.drawPieceStatusDisplay(Xe.getStatusDisplay()),Ce=0,Pe=0,be=0,Ve=!1,at(),mt(),Be=90,Oe=c.GameState.FIRST_PIECE,document.activeElement.blur(),qe.drawBoard(),qe.drawCurrentPiece(),lt(),ft(),St()}function ct(){Oe==c.GameState.FIRST_PIECE&&0==Be?Oe=c.GameState.RUNNING:Oe==c.GameState.LINE_CLEAR&&0==Ue?Oe=c.GameState.ARE:Oe==c.GameState.ARE&&0==we?(Ce+=Ge,Ge=0,ft(),mt(),qe.drawCurrentPiece(),ht(Le),qe.drawPieceStatusDisplay(Xe.getStatusDisplay()),!function(){const e=_e.activeTetromino;for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)if(e[t][n]&&Re[_e.y+t][_e.x+n])return!0;return!1}()?Oe=c.GameState.RUNNING:(Oe=c.GameState.GAME_OVER,St(),lt(),console.log("Average:",(He/Fe).toFixed(3),"Max:",Ze.toFixed(3)))):Oe==c.GameState.RUNNING&&(Ue>0?Oe=c.GameState.LINE_CLEAR:we>0&&(Oe=c.GameState.ARE))}function dt(){if(!Ve){switch(Oe){case c.GameState.FIRST_PIECE:Be-=1,De.handleInputsThisFrame();break;case c.GameState.LINE_CLEAR:Ue-=1,qe.drawLineClears(ke,c.LINE_CLEAR_DELAY-Ue),0==Ue&&function(){const e=ke.length;for(const e of ke){Re.splice(e,1),Re.splice(0,0,[]);for(let e=0;e<c.NUM_COLUMN;e++)Re[0].push(c.SquareState.EMPTY)}ke=[],e>0&&(be+=e,4==e&&(Pe+=1),(Se.shouldTransitionEveryLine()||be>=Me)&&(ve+=1,Me+=10),Ge+=c.REWARDS[e]*(ve+1),qe.drawBoard())}();break;case c.GameState.ARE:we-=1;break;case c.GameState.RUNNING:De.handleInputsThisFrame(),De.getIsSoftDropping()?Ne=0:(Ne+=1,Ne>=Object(c.GetGravity)(ve)&&(gt(),Ne=0))}ct()}const e=60*Se.getGameSpeedMultiplier();window.setTimeout(dt,1e3/e)}function lt(){let e="";if(Ve)e="Paused";else switch(Oe){case c.GameState.START_SCREEN:e="Welcome to Tetris Trainer!";break;case c.GameState.EDIT_STARTING_BOARD:e="Use your mouse to edit the board, then click enter to start!";break;case c.GameState.RANDOM_BOARD:e="Try to guess what StackRabbit would play, or click enter to start!";break;case c.GameState.GAME_OVER:e="Game over!"}Ee.innerText=e}function ut(e,t){let n=0;for(let i=0;i<c.NUM_ROW;i++)for(let r=Math.max(0,e);r<Math.min(t,10);r++)if(Re[i][r]!=c.SquareState.EMPTY){n+=(i+r)%2==0?1:-1}return Math.abs(n)}function ht(e){qe.drawNextBox(e),null!==e&&je.updatePieces(_e.id,Le.id)}function ft(){qe.drawLevelDisplay(ve,Te),qe.drawScoreDisplay(Ce,Te),qe.drawLinesDisplay(be,Te),qe.drawTetrisRateDisplay(Pe,be,Te)}function St(){Oe==c.GameState.START_SCREEN?ge.style.visibility="visible":ge.style.visibility="hidden",Oe==c.GameState.RANDOM_BOARD?me.style.visibility="visible":me.style.visibility="hidden"}function pt(){qe.unDrawCurrentPiece();const e=_e.moveLeft();return qe.drawCurrentPiece(),e}function Et(){qe.unDrawCurrentPiece();const e=_e.moveRight();return qe.drawCurrentPiece(),e}function gt(){return _e.shouldLock()?(function(){const e=_e.getHeightFromBottom();_e.lock(),De.onPieceLock(),qe.drawBoard(),ot(),je.updatePieces(_e.id,null),ke=function(){let e=[];for(let t=0;t<c.NUM_ROW;t++){let n=!0;for(let e=0;e<c.NUM_COLUMN;e++)if(Re[t][e]==c.SquareState.EMPTY){n=!1;break}n&&e.push(t)}return e}(),ke.length>0&&(Ue=c.LINE_CLEAR_DELAY);Ge+=Object(c.CalculatePushdownPoints)(De.getCellsSoftDropped()),we=10+2*Math.floor((e+2)/4)}(),!1):(qe.unDrawCurrentPiece(),_e.moveDown(),qe.drawCurrentPiece(),!0)}function mt(){Ye.addSnapshotToHistory([_e.id,Le.id,Xe.getReadIndex(),ve,be,Me,Ce,Pe,JSON.parse(JSON.stringify(Re))])}function yt(){const e=Ye.loadSnapshotFromHistory();let t,n,r,o;if(null!==e){[n,r,o,ve,be,Me,Ce,Pe,t]=e;for(let e=0;e<c.NUM_ROW;e++)for(let n=0;n<c.NUM_COLUMN;n++)Re[e][n]=t[e][n];_e=new T(i[n],Re),Le=new T(i[r],Re),Xe.setReadIndex(o),qe.drawPieceStatusDisplay(Xe.getStatusDisplay()),at(),Be=90,Oe=c.GameState.FIRST_PIECE,document.activeElement.blur(),qe.drawBoard(),qe.drawCurrentPiece(),ht(Le),lt(),ft(),St()}}function It(){qe.unDrawCurrentPiece(),_e.rotate(!1),qe.drawCurrentPiece()}function At(){qe.unDrawCurrentPiece(),_e.rotate(!0),qe.drawCurrentPiece()}function Tt(){return Oe==c.GameState.FIRST_PIECE||Oe==c.GameState.RUNNING||Oe==c.GameState.ARE||Oe==c.GameState.LINE_CLEAR}function Rt(){return Oe}ye.addEventListener("mousedown",(function(e){We.onMouseDown(e)})),ye.addEventListener("mousemove",(function(e){We.onMouseDrag(e)})),ye.addEventListener("mouseup",(function(e){We.onMouseUp(e)})),Ie.addEventListener("mouseleave",(function(e){We.onMouseUp(e)})),document.addEventListener("keydown",e=>{De.keyDownListener(e)}),document.addEventListener("keyup",e=>{De.keyUpListener(e)});const Dt={"preset-standard":fe.h,"preset-dig-practice":fe.a,"preset-drought":fe.b,"preset-killscreen":fe.d,"preset-slow-killscreen":fe.g,"preset-slow-19":fe.f};function _t(){for(const e in Dt)document.getElementById(e).classList.remove("selected")}for(const e in Dt){const t=Dt[e];document.getElementById(e).addEventListener("click",n=>{pe.loadPreset(t),_t(),console.log("selecting:",e),document.getElementById(e).classList.add("selected")})}document.getElementById("preset-edit-board").addEventListener("click",e=>{pe.loadPreset(fe.c),ve=Se.getStartingLevel(),be=0,Ce=0,Qe.loadEmptyBoard(),_e=null,qe.drawBoard(),Oe=c.GameState.EDIT_STARTING_BOARD,St(),lt(),ft()});const Lt=e=>{pe.loadPreset(fe.c),ve=Se.getStartingLevel(),be=0,Ce=0,Qe.loadStandardBoard(),Xe.generatePieceSequence(),Le=new T(Xe.getNextPiece(),Re),ot(),qe.drawBoard(),ht(Le),qe.drawCurrentPiece(),Oe=c.GameState.RANDOM_BOARD,St(),lt(),ft()};document.getElementById("preset-random-board").addEventListener("click",Lt),me.addEventListener("click",Lt),document.getElementById("start-button").addEventListener("click",e=>st()),De=new v,at(),document.getElementById("preset-standard").click(),window.setTimeout(()=>{qe.drawBoard(),ht(null),De.refreshDebugText(),lt(),ft(),dt()},200)}]);